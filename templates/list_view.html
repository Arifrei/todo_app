{% extends 'base.html' %}

{% block content %}
<div class="list-view{% if todo_list.type == 'light' %} light-list-view{% endif %}">
{# Phase headers: anything marked is_phase or legacy status == 'phase' #}
{% set phases = items|selectattr('is_phase', 'equalto', True)|list + items|selectattr('status', 'equalto', 'phase')|list %}
{% set tag_ns = namespace(all=[]) %}
{% for item in items %}
    {% for tag in item.tag_list() %}
        {% if tag not in tag_ns.all %}
            {% set tag_ns.all = tag_ns.all + [tag] %}
        {% endif %}
    {% endfor %}
{% endfor %}
{% set all_tags = tag_ns.all|sort %}

{# Compute counts for hub progress #}
{% if todo_list.type == 'hub' %}
{% set total = todo_list.items|length %}
{% set done_count = 0 %}
{% for item in todo_list.items %}
    {% if item.linked_list %}
        {% if item.linked_list.get_progress() == 100 %}
            {% set done_count = done_count + 1 %}
        {% endif %}
    {% else %}
        {% if item.status == 'done' %}
            {% set done_count = done_count + 1 %}
        {% endif %}
    {% endif %}
{% endfor %}
{% endif %}

<!-- Compact Sticky Header -->
<div class="list-header-compact sticky-header">
    <div class="header-left">
        {% if parent_list %}
        <a href="/list/{{ parent_list.id }}" class="btn btn-back btn-small" aria-label="Back to {{ parent_list.title }}">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        {% else %}
        <a href="/tasks" class="btn btn-back btn-small" aria-label="Go back">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        {% endif %}
        <a href="/tasks" class="btn btn-home" aria-label="Tasks home">
            <i class="fa-solid fa-list-check"></i>
        </a>
    </div>

    <div class="header-center">
        <h1 id="list-title-display">{{ todo_list.title }}</h1>
    </div>

    <div class="header-right">
        {% if todo_list.type == 'list' %}
        <div class="header-add-menu">
            <button class="btn btn-primary header-add-trigger" data-onclick="toggleHeaderAddMenu(event)" title="Add" aria-label="Add options" aria-controls="header-add-dropdown" aria-expanded="false">
                <i class="fa-solid fa-plus"></i>
                <span>Add</span>
                <i class="fa-solid fa-caret-down"></i>
            </button>
            <div class="header-menu-dropdown header-add-dropdown" id="header-add-dropdown">
                <button class="header-menu-item" data-onclick="openAddItemModal(null, 'task'); toggleHeaderAddMenu(event);">
                    <i class="fa-solid fa-plus"></i> Add Task
                </button>
                <button class="header-menu-item" data-onclick="openAddItemModal(null, 'phase'); toggleHeaderAddMenu(event);">
                    <i class="fa-solid fa-layer-group"></i> Add Phase
                </button>
            </div>
        </div>
        {% elif todo_list.type == 'light' %}
        <button class="btn btn-primary" data-onclick="openAddItemModal(null, 'task')" title="Add Task">
            <i class="fa-solid fa-plus"></i>
            <span>Add</span>
        </button>
        {% else %}
        <div class="header-add-menu">
            <button class="btn btn-primary header-add-trigger" data-onclick="toggleHeaderAddMenu(event)" title="Add" aria-label="Add options" aria-controls="header-add-dropdown" aria-expanded="false">
                <i class="fa-solid fa-plus"></i>
                <span>Add</span>
                <i class="fa-solid fa-caret-down"></i>
            </button>
            <div class="header-menu-dropdown header-add-dropdown" id="header-add-dropdown">
                <button class="header-menu-item" data-onclick="openAddItemModal(null, 'project_list'); toggleHeaderAddMenu(event);">
                    <i class="fa-solid fa-list-check"></i> Add Project (List)
                </button>
                <button class="header-menu-item" data-onclick="openAddItemModal(null, 'project_hub'); toggleHeaderAddMenu(event);">
                    <i class="fa-solid fa-folder-tree"></i> Add Project (Hub)
                </button>
            </div>
        </div>
        {% endif %}
        <button class="btn-icon header-menu-trigger" data-onclick="toggleHeaderMenu(event)" title="More options" aria-label="More list options" aria-controls="header-menu-dropdown" aria-expanded="false">
            <i class="fa-solid fa-ellipsis-vertical"></i>
        </button>
        <div class="header-menu-dropdown" id="header-menu-dropdown">
            <button class="header-menu-item" data-onclick="openBulkImportModal(); toggleHeaderMenu(event);">
                <i class="fa-solid fa-list-check"></i> Bulk Add
            </button>
            <a class="header-menu-item" href="/api/lists/{{ todo_list.id }}/export" download>
                <i class="fa-solid fa-download"></i> Export
            </a>
            <div class="header-menu-divider"></div>
            <button class="header-menu-item" data-onclick="openEditListModal(); toggleHeaderMenu(event);">
                <i class="fa-solid fa-pen"></i> Rename List
            </button>
            <button class="header-menu-item danger" data-onclick="deleteList({{ todo_list.id }});">
                <i class="fa-solid fa-trash"></i> Delete List
            </button>
        </div>
    </div>
</div>

{% if todo_list.type != 'light' %}
<div class="task-filter-row">
    <div class="task-filter-dropdown" id="task-filter-dropdown">
        <button class="btn btn-secondary btn-filter-trigger" type="button" data-onclick="toggleTaskFilterMenu(event)" aria-label="Task filters" aria-controls="task-filter-menu" aria-expanded="false">
            <i class="fa-solid fa-filter"></i>
            <span id="task-filter-label">Filter</span>
            <i class="fa-solid fa-caret-down"></i>
        </button>
        <div class="task-filter-menu" id="task-filter-menu">
            <button class="task-filter-item task-filter-parent" type="button" data-onclick="toggleTaskFilterSubmenu('status', event)" aria-label="Status filters" aria-controls="task-filter-submenu-status" aria-expanded="false">
                <span>Status</span>
                <i class="fa-solid fa-caret-right"></i>
            </button>
            <div class="task-filter-submenu" id="task-filter-submenu-status">
                <button class="task-filter-item active" data-filter="all">All Tasks</button>
                <button class="task-filter-item" data-filter="not_started">Not Started</button>
                <button class="task-filter-item" data-filter="in_progress">Started</button>
                <button class="task-filter-item" data-filter="done">Done</button>
            </div>
            {% if todo_list.type == 'list' and all_tags|length %}
            <button class="task-filter-item task-filter-parent" type="button" data-onclick="toggleTaskFilterSubmenu('tags', event)" aria-label="Tag filters" aria-controls="task-filter-submenu-tags" aria-expanded="false">
                <span>Tags</span>
                <i class="fa-solid fa-caret-right"></i>
            </button>
            <div class="task-filter-submenu" id="task-filter-submenu-tags">
                <button class="task-filter-item tag-filter-chip active" data-tag="__all" type="button">All Tags</button>
                {% for tag in all_tags %}
                <button class="task-filter-item tag-filter-chip" data-tag="{{ tag }}" type="button">{{ tag }}</button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    <div class="task-filter-pills" id="task-filter-pills"></div>
</div>
{% endif %}

<div class="bulk-actions u-hidden" id="bulk-actions">
    <div class="bulk-left">
        <input type="checkbox" id="select-all" data-onchange="toggleSelectAll(this)">
        <label for="select-all" class="u-cursor-pointer">Select all</label>
        <span id="bulk-count" class="u-text-muted u-ml-05"></span>
        <button class="btn btn-secondary btn-small u-ml-05" type="button" data-onclick="resetTaskSelection()">Clear</button>
    </div>
    <div class="bulk-buttons">
        <button class="btn btn-secondary" data-onclick="openBulkMoveModal()">Move selected</button>
        <button class="btn-icon delete" data-onclick="bulkDelete()" title="Delete selected" aria-label="Delete selected tasks"><i class="fa-solid fa-trash"></i></button>
        <div class="bulk-menu">
            <button class="btn-icon bulk-more-btn" id="bulk-more-btn" type="button" aria-label="More bulk actions" aria-controls="bulk-menu-dropdown" aria-expanded="false" data-onclick="toggleBulkMenu(event)">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
            <div class="bulk-menu-dropdown" id="bulk-menu-dropdown">
                <button class="bulk-menu-item bulk-menu-parent" data-onclick="toggleBulkSubmenu('status', event)" aria-label="Change status actions" aria-controls="bulk-status-submenu" aria-expanded="false">
                    <span><i class="fa-solid fa-list-check"></i> Change status</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="bulk-menu-submenu" id="bulk-status-submenu">
                    <button class="bulk-menu-item" data-onclick="bulkUpdateStatus('not_started'); toggleBulkMenu(event, true);">
                        <i class="fa-solid fa-circle-dot"></i> Not Started
                    </button>
                    <button class="bulk-menu-item" data-onclick="bulkUpdateStatus('in_progress'); toggleBulkMenu(event, true);">
                        <i class="fa-solid fa-play"></i> Started
                    </button>
                    <button class="bulk-menu-item" data-onclick="bulkUpdateStatus('done'); toggleBulkMenu(event, true);">
                        <i class="fa-solid fa-check"></i> Done
                    </button>
                </div>
                {% if todo_list.type == 'list' %}
                <button class="bulk-menu-item bulk-menu-parent" data-onclick="toggleBulkSubmenu('tag', event)" aria-label="Tag actions" aria-controls="bulk-tag-form" aria-expanded="false">
                    <span><i class="fa-solid fa-tag"></i> Add tag</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </button>
                <div class="bulk-menu-form" id="bulk-tag-form">
                    <input type="text" id="bulk-tag-input" class="form-control" placeholder="Tag">
                    <button class="btn btn-secondary btn-small" type="button" data-onclick="bulkAddTag(); toggleBulkMenu(event, true);">Add</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="task-list" id="items-container">
{% for item in items %}
    {% set parent_phase_id = item.phase_id if (item.phase_id and todo_list.type == 'list') else '' %}
    {% set tag_list = item.tag_list() %}
    {% set is_blocked = (todo_list.type == 'list' and (item.id in blocked_ids) and (not item.is_phase) and item.status != 'phase') %}
    {% if todo_list.type == 'list' and item.is_phase %}
        {% set phase_tasks = item.phase_tasks
            |selectattr('is_phase', 'equalto', False)
            |selectattr('status', 'ne', 'phase')
            |list %}
        {% set phase_done = phase_tasks|selectattr('status', 'equalto', 'done')|list|length %}
        {% set phase_not_done = (phase_tasks|length) - phase_done %}
    {% endif %}
    <div class="task-item {{ 'phase' if (todo_list.type == 'list' and item.is_phase) else '' }} {{ 'under-phase' if parent_phase_id else '' }} status-{{ item.status }}{% if is_blocked %} blocked-task{% endif %} {% if item.linked_list and item.linked_list.type == 'hub' %}item-is-hub{% endif %}" id="item-{{ item.id }}" data-status="{{ item.status }}" data-item-id="{{ item.id }}" data-phase-id="{{ item.id if (todo_list.type == 'list' and item.is_phase) else '' }}" data-phase-parent="{{ parent_phase_id }}" data-tags="{{ tag_list|join(',') if todo_list.type == 'list' else '' }}" data-deps="{% if todo_list.type == 'list' and not item.is_phase and item.status != 'phase' %}{{ item.dependencies|map(attribute='id')|list|join(',') }}{% endif %}"{% if is_blocked %} data-blocked="true"{% endif %}>
        <div class="task-content">
            <div class="drag-handle" title="Drag to reorder" data-drag-id="{{ item.id }}">
                <i class="fa-solid fa-grip-lines"></i>
            </div>

            <div class="task-body u-flex-1">
                <div class="task-title-row">
                    {% if todo_list.type == 'list' and item.is_phase %}
                    <button class="btn-icon phase-toggle" data-onclick="togglePhaseVisibility({{ item.id }})" aria-label="Toggle phase visibility">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                    {% endif %}
                    <div class="task-text">{{ item.content }}</div>
                    {% if todo_list.type == 'list' and item.is_phase %}
                    <span class="phase-count">{{ phase_not_done }} not done / {{ phase_done }} done</span>
                    {% endif %}
                    {% if item.linked_list and item.linked_list.type == 'hub' %}
                    <div class="hub-pill">Hub</div>
                    {% endif %}
                </div>
                {% if todo_list.type == 'list' and item.is_phase %}
                <div class="phase-pill">Phase</div>
                {% endif %}
                {% if item.description %}
                <div class="task-description u-fs-09 u-text-color u-mt-4px">{{
                    item.description|linkify_text }}</div>
                {% endif %}
                {% if item.notes %}
                <div class="task-notes u-fs-085 u-text-muted u-mt-4px u-italic">{{
                    item.notes|linkify_text }}</div>
                {% endif %}
                {% if todo_list.type == 'list' and tag_list %}
                <div class="task-tags">
                    {% for tag in tag_list %}
                    <span class="tag-chip" data-tag="{{ tag }}">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.due_date or (item.linked_notes|length) %}
                <div class="task-meta-lite u-mt-6px u-flex-wrap-gap-05">
                    {% if item.due_date %}
                    <span class="meta-chip time">Due {{ item.due_date }}</span>
                    {% endif %}
                    {% if item.linked_notes|length %}
                        {% for note in item.linked_notes %}
                        <a class="meta-chip note linked-note-chip" href="/notes/{{ note.id }}" title="Open note {{ note.title or ('#' ~ note.id) }}">
                            <i class="fa-solid fa-note-sticky"></i>
                            {{ note.title or ('Note #' ~ note.id) }}
                        </a>
                        {% endfor %}
                    {% endif %}
                </div>
                {% endif %}

                {% if todo_list.type == 'hub' and item.linked_list %}
                <div class="progress-container u-h-6px u-mt-05 u-w-150">
                    <div class="progress-bar" style="width: {{ item.linked_list.get_progress() }}%"></div>
                </div>
                <div class="u-fs-075 u-text-muted u-mt-2px">
                    {{ item.linked_list.get_progress() }}% Done
                </div>
                {% endif %}
            </div>
        </div>
        <div class="task-select-indicator"><i class="fa-solid fa-check"></i></div>

        <div class="task-footer">
            <div class="task-actions">
                {% if todo_list.type == 'hub' and item.linked_list_id %}
                <a href="/list/{{ item.linked_list_id }}" class="btn btn-secondary" role="button" aria-label="Open Project {{ item.content }}">
                    Open Project
                </a>
                <div class="task-actions-dropdown">
                    <button class="btn-icon" data-onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions" aria-label="More project actions" aria-controls="task-actions-menu-{{ item.id }}" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                        <button class="task-actions-menu-item" data-onclick="openMoveModal({{ item.id }}, 'project', '{{ item.content|replace('`', '\\`') }}'); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-people-roof"></i> Move Project
                        </button>
                        <button class="task-actions-menu-item danger" data-onclick="deleteItem({{ item.id }});">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if todo_list.type == 'list' and item.is_phase %}
                <button class="btn btn-secondary phase-inline-add" data-onclick="openAddItemModal({{ item.id }}, 'task')">
                    <i class="fa-solid fa-plus"></i> Add Task
                </button>
                <div class="task-actions-dropdown">
                    <button class="btn-icon" data-onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions" aria-label="More phase actions" aria-controls="task-actions-menu-{{ item.id }}" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                        <button class="task-actions-menu-item" data-onclick="openEditItemModal({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`, `{{ (item.description or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ (item.notes or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ (tag_list|join(', '))|replace('`', '\\`') }}`); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-pen"></i> Edit
                        </button>
                        <button class="task-actions-menu-item danger" data-onclick="deleteItem({{ item.id }});">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if todo_list.type in ['list', 'light'] and not item.is_phase %}
                <div class="status-buttons">
                    <button class="btn-status status-in_progress {% if item.status == 'in_progress' %}active{% endif %}" data-onclick="inlineToggleStatus({{ item.id }}, '{{ item.status }}', 'in_progress')">Started</button>
                    <button class="btn-status status-done {% if item.status == 'done' %}active{% endif %}" data-onclick="inlineToggleStatus({{ item.id }}, '{{ item.status }}', 'done')">Done</button>
                </div>

                    <div class="task-actions-dropdown">
                        <button class="btn-icon" data-onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions" aria-label="More task actions" aria-controls="task-actions-menu-{{ item.id }}" aria-expanded="false">
                            <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                        <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                            <button class="task-actions-menu-item" data-onclick="openEditItemModal({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`, `{{ (item.description or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ (item.notes or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ ((tag_list|join(', ')) if todo_list.type == 'list' else '')|replace('`', '\\`') }}`); toggleTaskActionsMenu({{ item.id }}, event);">
                                <i class="fa-solid fa-pen"></i> Edit
                            </button>
                            <button class="task-actions-menu-item" data-onclick="openMoveModal({{ item.id }}, 'task', '{{ item.content|replace('`', '\\`') }}'); toggleTaskActionsMenu({{ item.id }}, event);">
                                <i class="fa-solid fa-arrow-right"></i> Move to
                            </button>
                            <button class="task-actions-menu-item" data-onclick="setItemDate({{ item.id }}, '{{ item.due_date or '' }}', `{{ item.content|replace('`', '\\`') }}`); toggleTaskActionsMenu({{ item.id }}, event);">
                                <i class="fa-solid fa-calendar-days"></i> Date
                            </button>
                            <button class="task-actions-menu-item" data-onclick="linkNoteToItem({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`, {{ item.linked_notes|map(attribute='id')|list|tojson }}); toggleTaskActionsMenu({{ item.id }}, event);">
                                <i class="fa-solid fa-note-sticky"></i> Note
                            </button>
                            {% if todo_list.type == 'list' %}
                            {% set dep_titles = item.dependencies|map(attribute='content')|list %}
                            <button class="task-actions-menu-item" data-onclick="openDependencyModal({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`); toggleTaskActionsMenu({{ item.id }}, event);" {% if dep_titles %}title="Depends on: {{ dep_titles|join(', ') }}"{% endif %}>
                                <i class="fa-solid fa-link"></i> Dependencies{% if dep_titles %} ({{ dep_titles|length }}){% endif %}
                            </button>
                            {% endif %}
                            <button class="task-actions-menu-item danger" data-onclick="deleteItem({{ item.id }});">
                                <i class="fa-solid fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Item Modal -->
<div class="modal" id="add-item-modal" role="dialog" aria-modal="true" aria-labelledby="add-item-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="add-item-title">Add {{ 'Project' if todo_list.type == 'hub' else 'Task' }}</h2>
        <div class="form-group">
            <label for="item-content">Name</label>
            <input type="text" id="item-content" class="form-control" placeholder="Enter name...">
        </div>
        {% if todo_list.type == 'hub' %}
        <div class="form-group" id="project-type-select-group">
            <label for="project-type-select">Type</label>
            <select id="project-type-select" class="form-control">
                <option value="list" selected>Simple Task List</option>
                <option value="hub">Project Hub (for sub-projects)</option>
            </select>
        </div>
        {% endif %}
        {% if todo_list.type == 'list' %}
        <div class="form-group" id="phase-select-group">
            <label for="item-phase-select">Assign to phase (optional)</label>
            <select id="item-phase-select" class="form-control">
                <option value="">No phase</option>
                {% for phase in phases %}
                <option value="{{ phase.id }}">{{ phase.content }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        {% if todo_list.type in ['list', 'light'] %}
        <div class="form-group">
            <label for="item-description">Description</label>
            <textarea id="item-description" class="form-control" placeholder="Brief description..." rows="2"></textarea>
        </div>
        <div class="form-group">
            <label for="item-notes">Notes</label>
            <textarea id="item-notes" class="form-control" placeholder="Additional notes..." rows="3"></textarea>
        </div>
        {% endif %}
        {% if todo_list.type == 'list' %}
        <div class="form-group">
            <label for="item-tags">Tags (comma separated)</label>
            <input type="text" id="item-tags" class="form-control" placeholder="e.g. home, errands">
        </div>
        {% endif %}
        <input type="hidden" id="item-phase-id">
        <input type="hidden" id="item-mode" value="task">
        <div class="modal-actions">
            <button class="btn" data-onclick="closeAddItemModal()">Cancel</button>
            <button class="btn btn-primary"
                data-onclick="createItem({{ todo_list.id }}, '{{ todo_list.type }}')">Add</button>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal" id="edit-item-modal" role="dialog" aria-modal="true" aria-labelledby="edit-item-modal-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="edit-item-modal-title">Edit Task</h2>
        <input type="hidden" id="edit-item-id">
        <div class="form-group">
            <label for="edit-item-content">Name</label>
            <input type="text" id="edit-item-content" class="form-control">
        </div>
        <div class="form-group">
            <label for="edit-item-description">Description</label>
            <textarea id="edit-item-description" class="form-control" rows="2"></textarea>
        </div>
        <div class="form-group">
            <label for="edit-item-notes">Notes</label>
            <textarea id="edit-item-notes" class="form-control" rows="3"></textarea>
        </div>
        {% if todo_list.type == 'list' %}
        <div class="form-group">
            <label for="edit-item-tags">Tags (comma separated)</label>
            <input type="text" id="edit-item-tags" class="form-control">
        </div>
        {% endif %}
        <div class="modal-actions">
            <button class="btn" data-onclick="closeEditItemModal()">Cancel</button>
            <button class="btn btn-primary" data-onclick="saveItemChanges()">Save</button>
        </div>
    </div>
</div>

<!-- Dependency Picker Modal -->
<div class="modal" id="dependency-modal" role="dialog" aria-modal="true" aria-labelledby="dependency-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="dependency-title">Set Dependencies</h2>
        <div class="form-hint" id="dependency-target-label"></div>
        <div class="move-nav-header">
            <button class="btn btn-secondary u-hidden" id="dependency-back-button" data-onclick="dependencyNavBack()">Back</button>
        </div>
        <div id="dependency-step-container" class="move-step-container">
            <!-- Navigation options populated by JS -->
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeDependencyModal()">Cancel</button>
            <button class="btn btn-primary" data-onclick="saveDependencies()">Save</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal" id="bulk-import-modal" role="dialog" aria-modal="true" aria-labelledby="bulk-import-modal-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="bulk-import-modal-title">Bulk Import</h2>
        <p class="u-muted-modal-msg">Paste an outline to create phases and tasks instantly.</p>
        <div class="form-group">
            {% if todo_list.type == 'hub' %}
            <label for="bulk-import-text">Project Outline</label>
            <textarea id="bulk-import-text" class="form-control" rows="10" placeholder="# Project One
  ## Phase A
  - [ ] Task 1
  - [>] Task 2
# Project Two :: with description
  - [x] Completed Task"></textarea>
            {% elif todo_list.type == 'light' %}
            <label for="bulk-import-text">Task Outline</label>
            <textarea id="bulk-import-text" class="form-control" rows="10" placeholder="- [ ] Task 1 :: with description
- [x] Task 2
Task 3 ::: notes"></textarea>
            {% else %}
            <label for="bulk-import-text">Task Outline</label>
            <textarea id="bulk-import-text" class="form-control" rows="10" placeholder="# Phase One
- [ ] Task 1 :: with description
- [x] Task 2"></textarea>
            {% endif %}
        </div>
        <div class="form-group u-text-muted u-fs-09">
            {% if todo_list.type == 'hub' %}
            <div><strong>Projects:</strong> Start with <code># </code>. To create a nested hub, add <code>[hub]</code> at the end (e.g., <code># Q4 Initiatives [hub]</code>).</div>
            <div><strong>Phases:</strong> Indent under a project and use <code>## </code> (e.g., <code>  ## Discovery</code>).</div>
            <div><strong>Tasks:</strong> Indent under a project or phase and use <code>- </code>, <code>- [ ]</code>, <code>- [>]</code>, or <code>- [x]</code>.</div>
            {% elif todo_list.type == 'light' %}
            <div><strong>Tasks:</strong> Use <code>- </code>, <code>- [ ]</code>, <code>- [>]</code>, or <code>- [x]</code>.</div>
            {% else %}
            <div><strong>Phases:</strong> Start a line with <code># </code> (e.g., <code># My Phase</code>).</div>
            <div><strong>Tasks:</strong> Use <code>- [ ]</code>, <code>- [>]</code>, or <code>- [x]</code>.</div>
            {% endif %}
            <div class="u-mt-05"><strong>Metadata:</strong> Append <code>:: description</code> and/or <code>::: notes</code> to any line.</div>
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeBulkImportModal()">Cancel</button>
            <button class="btn btn-primary" data-onclick="bulkImportItems({{ todo_list.id }})">Import</button>
        </div>
    </div>
</div>

<!-- Move Item Modal -->
<div class="modal" id="move-item-modal" role="dialog" aria-modal="true" aria-labelledby="move-item-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="move-item-title">Move Item</h2>
        <input type="hidden" id="move-item-id">
        <div class="move-nav-header">
            <button class="btn btn-secondary u-hidden" id="move-back-button" data-onclick="moveNavBack()">Back</button>
        </div>
        <div id="move-step-container" class="move-step-container">
            <!-- Navigation options populated by JS -->
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeMoveModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div class="modal" id="edit-list-modal" role="dialog" aria-modal="true" aria-labelledby="edit-list-modal-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="edit-list-modal-title">Rename List</h2>
        <div class="form-group">
            <label for="edit-list-title">Title</label>
            <input type="text" id="edit-list-title" class="form-control">
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeEditListModal()">Cancel</button>
            <button class="btn btn-primary" data-onclick="saveListTitle()">Save</button>
        </div>
    </div>
</div>

<!-- Attach Date Modal -->
<div class="modal" id="date-picker-modal" role="dialog" aria-modal="true" aria-labelledby="date-picker-modal-title">
    <div class="modal-content" id="date-picker-modal-content" tabindex="-1">
        <h2 id="date-picker-modal-title">Attach Date</h2>
        <p id="date-picker-task-label" class="u-text-muted u-mt-neg-025"></p>
        <div class="form-group">
            <label for="date-picker-input">Select a date</label>
            <input type="date" id="date-picker-input" class="form-control">
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeDatePickerModal()">Cancel</button>
            <button class="btn btn-ghost" data-onclick="saveDatePickerSelection(true)">Remove Date</button>
            <button class="btn btn-primary" data-onclick="saveDatePickerSelection()">Attach Date</button>
        </div>
    </div>
</div>

<!-- Link Note Modal -->
<div class="modal" id="link-note-modal" role="dialog" aria-modal="true" aria-labelledby="link-note-modal-title">
    <div class="modal-content" tabindex="-1">
        <h2 id="link-note-modal-title">Link Note</h2>
        <p id="link-note-task-label" class="u-text-muted u-mt-neg-025"></p>
        <div class="form-group">
            <label id="link-note-list-label">Choose an existing note</label>
            <div id="link-note-list" class="note-chooser" aria-labelledby="link-note-list-label"></div>
        </div>
        <div class="form-group">
            <label for="link-note-new-title">Create a new note</label>
            <input type="text" id="link-note-new-title" class="form-control" placeholder="New note title (optional)">
        </div>
        <div class="modal-actions">
            <button class="btn" data-onclick="closeLinkNoteModal()">
                <i class="fa-solid fa-xmark note-action-icon"></i>
                <span class="note-action-text">Cancel</span>
            </button>
            <button class="btn btn-secondary" data-onclick="createAndLinkNote()">
                <i class="fa-solid fa-plus note-action-icon"></i>
                <span class="note-action-text">Create & Link</span>
            </button>
            <button class="btn btn-primary" data-onclick="saveLinkedNote()">
                <i class="fa-solid fa-link note-action-icon"></i>
                <span class="note-action-text">Attach Selected</span>
            </button>
        </div>
    </div>
</div>

<script>
    const CURRENT_LIST_ID = {{ todo_list.id }};
    const CURRENT_LIST_TYPE = '{{ todo_list.type }}';
    const CURRENT_LIST_TITLE = `{{ todo_list.title }}`;
    // Expose timezone for app.js without redeclaring the constant there
    window.USER_TIMEZONE = window.USER_TIMEZONE || '{{ default_timezone or "America/New_York" }}';

    // Initial progress calculation for Hub
    {% if todo_list.type == 'hub' %}
    document.addEventListener('DOMContentLoaded', () => {
        calculateHubProgress();
    });
    {% endif %}
</script>
</div>
{% endblock %}

{% block page_scripts %}
<script src="{{ url_for('static', filename='app/core.js') }}" defer></script>
<script src="{{ url_for('static', filename='app/tasks.js') }}" defer></script>
{% endblock %}




