{% extends 'base.html' %}

{% block content %}
{% set phases = items|selectattr('status', 'equalto', 'phase')|list %}
<div class="nav-links" style="margin-bottom: 1rem; display: flex; align-items: center;">
    {% if parent_list %}
    <a href="/list/{{ parent_list.id }}" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to {{
        parent_list.title }}</a>
    {% endif %}
    <a href="/" class="back-link" style="margin-left: 0.75rem;"><i class="fa-solid fa-house"></i> Home</a>
</div>

<div class="list-header sticky-header">
    <div class="card-header">
        <div>
            <h1 id="list-title-display">{{ todo_list.title }}</h1>
            <span class="card-type">{{ todo_list.type }}</span>
        </div>
        <div class="task-actions">
            <button class="btn-icon" onclick="openEditListModal()"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-icon" style="color: var(--danger-color);" onclick="deleteList({{ todo_list.id }})"><i
                    class="fa-solid fa-trash"></i></button>
        </div>
    </div>

    {% if todo_list.type == 'hub' %}
    {# Compute counts: treat a project as complete when the linked list is 100% or a simple item is 'done' #}
    {% set total = todo_list.items|length %}
    {% set done_count = 0 %}
    {% for item in todo_list.items %}
        {% if item.linked_list %}
            {% if item.linked_list.get_progress() == 100 %}
                {% set done_count = done_count + 1 %}
            {% endif %}
        {% else %}
            {% if item.status == 'done' %}
                {% set done_count = done_count + 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}

    <div class="progress-container" style="margin-top: 1.5rem;">
        <div class="progress-bar" id="main-progress-bar" style="width: {{ todo_list.get_progress() }}%"></div>
    </div>
    <div class="progress-text">
        <span id="progress-percent">{{ todo_list.get_progress() }}% Complete</span>
        <span id="progress-count">{{ done_count }}/{{ total }} Projects</span>
    </div>
    {% endif %}
</div>

<div class="header-row">
    <h2>{{ 'Projects' if todo_list.type == 'hub' else 'Tasks' }}</h2>
    <div class="header-actions">
        <a class="btn btn-secondary" href="/api/lists/{{ todo_list.id }}/export" download>
            <i class="fa-solid fa-download"></i> Export
        </a>
        <button class="btn" onclick="openBulkImportModal()">
            <i class="fa-solid fa-list-check"></i> Bulk Add
        </button>

        {% if todo_list.type == 'list' %}
        <div class="phase-add-dropdown">
            <button class="btn btn-primary btn-secondary" type="button" onclick="togglePhaseMenu(event)">
                <i class="fa-solid fa-plus"></i> Add
            </button>
            <!-- Main Menu -->
            <div class="phase-menu" id="phase-menu-main">
                <button class="phase-menu-item" onclick="openAddItemModal(null, 'phase'); togglePhaseMenu(event, true);">
                    <i class="fa-solid fa-layer-group"></i> Add Phase
                </button>
                <button class="phase-menu-item" onclick="openAddItemModal(null, 'task'); togglePhaseMenu(event, true);">
                    <i class="fa-solid fa-tasks"></i> Add Task
                </button>
            </div>
            <!-- Sub-menu removed -->
        </div>
        {% else %}
        <!-- This is the 'hub' view -->
        <div class="phase-add-dropdown">
            <button class="btn btn-primary btn-secondary" type="button" onclick="togglePhaseMenu(event)">
                <i class="fa-solid fa-plus"></i> Add
            </button>
            <div class="phase-menu" id="phase-menu-main">
                <button class="phase-menu-item" onclick="openAddItemModal(null, 'project_list'); togglePhaseMenu(event, true);">
                    <i class="fa-solid fa-list-check"></i> Add Project (List)
                </button>
                <button class="phase-menu-item" onclick="openAddItemModal(null, 'project_hub'); togglePhaseMenu(event, true);">
                    <i class="fa-solid fa-folder-tree"></i> Add Project (Hub)
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="bulk-actions" id="bulk-actions" style="display: none;">
    <div class="bulk-left">
        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
        <label for="select-all" style="cursor: pointer;">Select all</label>
        <span id="bulk-count" style="color: var(--text-muted); margin-left: 0.5rem;"></span>
    </div>
    <div class="bulk-buttons">
        <button class="btn-status status-pending" onclick="bulkUpdateStatus('not_started')">Not Started</button>
        <button class="btn-status status-in_progress" onclick="bulkUpdateStatus('in_progress')">Started</button>
        <button class="btn-status status-done" onclick="bulkUpdateStatus('done')">Done</button>
        <button class="btn btn-secondary" onclick="openBulkMoveModal()">Move toâ€¦</button>
        <button class="btn-icon delete" onclick="bulkDelete()" title="Delete selected"><i class="fa-solid fa-trash"></i></button>
    </div>
</div>

<div class="task-list" id="items-container">
{% set current_phase_id = None %}
{% for item in items %}
    {% if item.is_phase %}
        {% set current_phase_id = item.id %}
    {% endif %}
    {% set parent_phase_id = item.phase_id if item.phase_id else current_phase_id if not item.is_phase else '' %}
    <div class="task-item {{ 'phase' if item.is_phase else '' }} {{ 'under-phase' if parent_phase_id else '' }} status-{{ item.status }} {% if item.linked_list and item.linked_list.type == 'hub' %}item-is-hub{% endif %}" id="item-{{ item.id }}" data-status="{{ item.status }}" data-item-id="{{ item.id }}" data-phase-id="{{ item.id if item.is_phase else '' }}" data-phase-parent="{{ parent_phase_id }}">
        <div class="task-content">
            <input type="checkbox" class="select-item" data-item-id="{{ item.id }}" data-status="{{ item.status }}" onchange="toggleSelectItem({{ item.id }}, this.checked)">
            <div class="drag-handle" title="Drag to reorder" data-drag-id="{{ item.id }}">
                <i class="fa-solid fa-grip-lines"></i>
            </div>

            <div class="task-body" style="flex: 1;">
                <div class="task-title-row">
                    {% if item.is_phase %}
                    <button class="btn-icon phase-toggle" onclick="togglePhaseVisibility({{ item.id }})" aria-label="Toggle phase visibility">
                        <i class="fa-solid fa-chevron-up"></i>
                    </button>
                    {% endif %}
                    <div class="task-text">{{ item.content }}</div>
                    {% if item.linked_list and item.linked_list.type == 'hub' %}
                    <div class="hub-pill">Hub</div>
                    {% endif %}
                </div>
                {% if item.is_phase %}
                <div class="phase-pill">Phase</div>
                {% endif %}
                {% if item.description %}
                <div class="task-description" style="font-size: 0.9rem; color: var(--text-color); margin-top: 4px;">{{
                    item.description }}</div>
                {% endif %}
                {% if item.notes %}
                <div class="task-notes"
                    style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; font-style: italic;">{{
                    item.notes }}</div>
                {% endif %}

                {% if todo_list.type == 'hub' and item.linked_list %}
                <div class="progress-container" style="height: 6px; margin-top: 0.5rem; width: 150px;">
                    <div class="progress-bar" style="width: {{ item.linked_list.get_progress() }}%"></div>
                </div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">
                    {{ item.linked_list.get_progress() }}% Done
                </div>
                {% endif %}
            </div>
        </div>

        <div class="task-footer">
            <div class="task-actions">
                {% if todo_list.type == 'hub' and item.linked_list_id %}
                <a href="/list/{{ item.linked_list_id }}" class="btn btn-secondary" role="button" aria-label="Open Project {{ item.content }}">
                    Open Project
                </a>
                <div class="task-actions-dropdown">
                    <button class="btn-icon" onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                        <button class="task-actions-menu-item" onclick="openMoveModal({{ item.id }}, 'project', '{{ item.content|replace('`', '\\`') }}'); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-people-roof"></i> Move Project
                        </button>
                        <button class="task-actions-menu-item danger" onclick="deleteItem({{ item.id }});">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if item.is_phase %}
                <button class="btn btn-secondary phase-inline-add" onclick="openAddItemModal({{ item.id }}, 'task')">
                    <i class="fa-solid fa-plus"></i> Add Task
                </button>
                <div class="task-actions-dropdown">
                    <button class="btn-icon" onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                        <button class="task-actions-menu-item" onclick="openEditItemModal({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`, `{{ (item.description or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ (item.notes or '')|replace('`', '\\`')|replace('\n', '\\n') }}`); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-pen"></i> Edit
                        </button>
                        <button class="task-actions-menu-item danger" onclick="deleteItem({{ item.id }});">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if todo_list.type == 'list' and not item.is_phase %}
                <div class="status-buttons">
                    <button class="btn-status status-in_progress {% if item.status == 'in_progress' %}active{% endif %}" onclick="inlineToggleStatus({{ item.id }}, '{{ item.status }}', 'in_progress')">Started</button>
                    <button class="btn-status status-done {% if item.status == 'done' %}active{% endif %}" onclick="inlineToggleStatus({{ item.id }}, '{{ item.status }}', 'done')">Done</button>
                </div>

                <div class="task-actions-dropdown">
                    <button class="btn-icon" onclick="toggleTaskActionsMenu({{ item.id }}, event)" title="More actions">
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <div class="task-actions-menu" id="task-actions-menu-{{ item.id }}">
                        <button class="task-actions-menu-item" onclick="openMoveModal({{ item.id }}, 'task', '{{ item.content|replace('`', '\\`') }}'); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-arrow-right-to-bracket"></i> Move Task
                        </button>
                        <button class="task-actions-menu-item" onclick="openEditItemModal({{ item.id }}, `{{ item.content|replace('`', '\\`') }}`, `{{ (item.description or '')|replace('`', '\\`')|replace('\n', '\\n') }}`, `{{ (item.notes or '')|replace('`', '\\`')|replace('\n', '\\n') }}`); toggleTaskActionsMenu({{ item.id }}, event);">
                            <i class="fa-solid fa-pen"></i> Edit
                        </button>
                        <button class="task-actions-menu-item danger" onclick="deleteItem({{ item.id }});">
                            <i class="fa-solid fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Item Modal -->
<div class="modal" id="add-item-modal">
    <div class="modal-content">
        <h2 id="add-item-title">Add {{ 'Project' if todo_list.type == 'hub' else 'Task' }}</h2>
        <br>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="item-content" class="form-control" placeholder="Enter name...">
        </div>
        {% if todo_list.type == 'hub' %}
        <div class="form-group" id="project-type-select-group">
            <label>Type</label>
            <select id="project-type-select" class="form-control">
                <option value="list" selected>Simple Task List</option>
                <option value="hub">Project Hub (for sub-projects)</option>
            </select>
        </div>
        {% endif %}
        {% if todo_list.type == 'list' %}
        <div class="form-group" id="phase-select-group">
            <label>Assign to phase (optional)</label>
            <select id="item-phase-select" class="form-control">
                <option value="">No phase</option>
                {% for phase in phases %}
                <option value="{{ phase.id }}">{{ phase.content }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="item-description" class="form-control" placeholder="Brief description..." rows="2"></textarea>
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea id="item-notes" class="form-control" placeholder="Additional notes..." rows="3"></textarea>
        </div>
        {% endif %}
        <input type="hidden" id="item-phase-id">
        <input type="hidden" id="item-mode" value="task">
        <div class="modal-actions">
            <button class="btn" onclick="closeAddItemModal()">Cancel</button>
            <button class="btn btn-primary"
                onclick="createItem({{ todo_list.id }}, '{{ todo_list.type }}')">Add</button>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal" id="edit-item-modal">
    <div class="modal-content">
        <h2>Edit Task</h2>
        <br>
        <input type="hidden" id="edit-item-id">
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="edit-item-content" class="form-control">
        </div>
        <div class="form-group">
            <label>Description</label>
            <textarea id="edit-item-description" class="form-control" rows="2"></textarea>
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea id="edit-item-notes" class="form-control" rows="3"></textarea>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeEditItemModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveItemChanges()">Save</button>
        </div>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal" id="bulk-import-modal">
    <div class="modal-content">
        <h2>Bulk Import</h2>
        <p style="color: var(--text-muted); margin: 0.25rem 0 1rem 0;">Paste an outline to create phases and tasks instantly.</p>
        <div class="form-group">
            {% if todo_list.type == 'hub' %}
            <label>Project Outline</label>
            <textarea id="bulk-import-text" class="form-control" rows="10" placeholder="# Project One
  ## Phase A
  - [ ] Task 1
  - [>] Task 2
# Project Two :: with description
  - [x] Completed Task"></textarea>
            {% else %}
            <label>Task Outline</label>
            <textarea id="bulk-import-text" class="form-control" rows="10" placeholder="# Phase One
- [ ] Task 1 :: with description
- [x] Task 2"></textarea>
            {% endif %}
        </div>
        <div class="form-group" style="color: var(--text-muted); font-size: 0.9rem;">
            {% if todo_list.type == 'hub' %}
            <div><strong>Projects:</strong> Start with <code># </code>. To create a nested hub, add <code>[hub]</code> at the end (e.g., <code># Q4 Initiatives [hub]</code>).</div>
            <div><strong>Phases:</strong> Indent under a project and use <code>## </code> (e.g., <code>  ## Discovery</code>).</div>
            <div><strong>Tasks:</strong> Indent under a project or phase and use <code>- </code>, <code>- [ ]</code>, <code>- [>]</code>, or <code>- [x]</code>.</div>
            {% else %}
            <div><strong>Phases:</strong> Start a line with <code># </code> (e.g., <code># My Phase</code>).</div>
            <div><strong>Tasks:</strong> Use <code>- [ ]</code>, <code>- [>]</code>, or <code>- [x]</code>.</div>
            {% endif %}
            <div style="margin-top: 0.5rem;"><strong>Metadata:</strong> Append <code>:: description</code> and/or <code>::: notes</code> to any line.</div>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeBulkImportModal()">Cancel</button>
            <button class="btn btn-primary" onclick="bulkImportItems({{ todo_list.id }})">Import</button>
        </div>
    </div>
</div>

<!-- Move Item Modal -->
<div class="modal" id="move-item-modal">
    <div class="modal-content">
        <h2 id="move-item-title">Move Item</h2>
        <br>
        <input type="hidden" id="move-item-id">
        <div class="move-nav-header">
            <button class="btn btn-secondary" id="move-back-button" style="display:none;" onclick="moveNavBack()">Back</button>
        </div>
        <div id="move-step-container" class="move-step-container">
            <!-- Navigation options populated by JS -->
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeMoveModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit List Modal -->
<div class="modal" id="edit-list-modal">
    <div class="modal-content">
        <h2>Rename List</h2>
        <br>
        <div class="form-group">
            <label>Title</label>
            <input type="text" id="edit-list-title" class="form-control">
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="closeEditListModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveListTitle()">Save</button>
        </div>
    </div>
</div>

<script>
    const CURRENT_LIST_ID = {{ todo_list.id }};
    const CURRENT_LIST_TYPE = '{{ todo_list.type }}';
    const CURRENT_LIST_TITLE = `{{ todo_list.title }}`;

    // Initial progress calculation for Hub
    {% if todo_list.type == 'hub' %}
    document.addEventListener('DOMContentLoaded', () => {
        calculateHubProgress();
    });
    {% endif %}
</script>
{% endblock %}
